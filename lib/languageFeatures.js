var __assign=this&&this.__assign||Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var __generator=this&&this.__generator||function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=y[op[0]&2?"return":op[0]?"throw":"next"])&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[0,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};define(["require","exports","./definitions","vscode-languageserver-types"],function(require,exports,definitions_1,ls){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Range=monaco.Range;var MarkerSeverity;(function(MarkerSeverity){MarkerSeverity[MarkerSeverity["Hint"]=1]="Hint";MarkerSeverity[MarkerSeverity["Info"]=2]="Info";MarkerSeverity[MarkerSeverity["Warning"]=4]="Warning";MarkerSeverity[MarkerSeverity["Error"]=8]="Error"})(MarkerSeverity=exports.MarkerSeverity||(exports.MarkerSeverity={}));var Global={HotWords:[],EditingWord:{line:0,offset:0}};var completeTrigger={ODPSSQL:[" ","."],HiveSQL:[" ","."],Shell:[" ","-"]};var DiagnosticsAdapter=function(){function DiagnosticsAdapter(_languageId,_worker,defaults){var _this=this;this._languageId=_languageId;this._worker=_worker;this._disposables=[];this._listener=Object.create(null);var onModelAdd=function(model){var handle;var modeId=model.getModeId();if(modeId!==_this._languageId){return}_this._listener[model.uri.toString()]=model.onDidChangeContent(function(insertText){clearTimeout(handle);var change=insertText.changes[0]||{};handle=setTimeout(function(){return _this._doValidate(model.uri,modeId,(change.text||"").indexOf(" ")>0)},1e3);if(change.text===""){Global.EditingWord={line:change.range.startLineNumber,offset:change.range.startColumn-1}}else{Global.EditingWord={line:change.range.startLineNumber,offset:change.range.startColumn}}if(change.forceMoveMarkers===undefined){var i=0;for(i;i<Global.HotWords.length;i++){if(Global.HotWords[i].text===change.text){Global.HotWords[i].visited++;break}}if(i===Global.HotWords.length){Global.HotWords.push({text:change.text,visited:1})}}});_this._doValidate(model.uri,modeId,true)};var onModelRemoved=function(model){monaco.editor.setModelMarkers(model,_this._languageId,[]);var uriStr=model.uri.toString();var listener=_this._listener[uriStr];if(listener){listener.dispose();delete _this._listener[uriStr]}};this._disposables.push(monaco.editor.onDidCreateModel(onModelAdd));this._disposables.push(monaco.editor.onWillDisposeModel(onModelRemoved));this._disposables.push(monaco.editor.onDidChangeModelLanguage(function(event){onModelRemoved(event.model);onModelAdd(event.model)}));defaults.onDidChange(function(_){monaco.editor.getModels().forEach(function(model){if(model.getModeId()===_this._languageId){onModelRemoved(model);onModelAdd(model)}})});this._disposables.push({dispose:function(){for(var key in _this._listener){_this._listener[key].dispose()}}});monaco.editor.getModels().forEach(onModelAdd)}DiagnosticsAdapter.prototype.dispose=function(){this._disposables.forEach(function(d){return d&&d.dispose()});this._disposables=[]};DiagnosticsAdapter.prototype._doValidate=function(resource,languageId,isBatch){this._worker(resource).then(function(worker){return worker.doValidation(resource.toString(),isBatch)}).then(function(diagnostics){var markers=diagnostics.map(function(d){return toDiagnostics(resource,d)});var model=monaco.editor.getModel(resource);if(model.getModeId()===languageId){monaco.editor.setModelMarkers(model,languageId,markers)}}).done(undefined,function(err){console.error(err)})};return DiagnosticsAdapter}();exports.DiagnosticsAdapter=DiagnosticsAdapter;function toSeverity(lsSeverity){switch(lsSeverity){case ls.DiagnosticSeverity.Error:return MarkerSeverity.Error;case ls.DiagnosticSeverity.Warning:return MarkerSeverity.Warning;case ls.DiagnosticSeverity.Information:return MarkerSeverity.Info;case ls.DiagnosticSeverity.Hint:return MarkerSeverity.Hint;default:return MarkerSeverity.Info}}function toDiagnostics(resource,diag){var code=typeof diag.code==="number"?String(diag.code):diag.code;return{severity:toSeverity(diag.severity),startLineNumber:diag.range.start.line+1,startColumn:diag.range.start.character+1,endLineNumber:diag.range.end.line+1,endColumn:diag.range.end.character+1,message:diag.message,code:code,source:diag.source}}function fromPosition(position){if(!position){return void 0}return{character:position.column-1,line:position.lineNumber-1}}function fromRange(range){if(!range){return void 0}return{start:{line:range.startLineNumber-1,character:range.startColumn-1},end:{line:range.endLineNumber-1,character:range.endColumn-1}}}function toRange(range){if(!range){return void 0}return new monaco.Range(range.start.line+1,range.start.character+1,range.end.line+1,range.end.character+1)}function toTextEdit(textEdit){if(!textEdit){return void 0}return{range:toRange(textEdit.range),text:textEdit.newText}}var CompletionAdapter=function(){function CompletionAdapter(_worker,options,languageId){this._worker=_worker;this.visitedTable=[];this.options=options;this.languageId=languageId}CompletionAdapter.prototype.cleanCache=function(){this.visitedTable=[]};CompletionAdapter.prototype.updateOptions=function(options){this.options=options};Object.defineProperty(CompletionAdapter.prototype,"triggerCharacters",{get:function(){return completeTrigger[this.languageId]},enumerable:true,configurable:true});CompletionAdapter.prototype.provideCompletionItems=function(model,position,token){var _this=this;var wordInfo=model.getWordUntilPosition(position);var resource=model.uri;var visitedTable=this.visitedTable;return wireCancellationToken(token,this._worker(resource).then(function(worker){return worker.doComplete(resource.toString(),fromPosition(position),_this.languageId,__assign({},Global,{TokenEnum:definitions_1.TokenMap[_this.languageId]}),visitedTable,_this.options)}).then(function(info){console.log("CompletionAdapter ========> info: ",info);if(!info){console.log("CompletionAdapter ========> nothing");return}var items=info.items.map(function(entry){var item={label:entry.label,insertText:entry.insertText,sortText:entry.sortText,filterText:entry.filterText,documentation:entry.documentation,detail:entry.detail,kind:entry.kind};if(entry.textEdit){item.range=toRange(entry.textEdit.range);item.insertText=entry.textEdit.newText}if(entry.additionalTextEdits){item.additionalTextEdits=entry.additionalTextEdits.map(toTextEdit)}if(entry.insertTextFormat===ls.InsertTextFormat.Snippet){item.insertText={value:item.insertText}}return item});_this.visitedTable=info.visitedTable;if(info.fixedValue){model.applyEdits([{range:new Range(info.fixedValue.startLineNumber+1,info.fixedValue.startColumn+1,info.fixedValue.endLineNumber+1,info.fixedValue.endColumn+1),text:info.fixedValue.text}])}return{isIncomplete:info.isIncomplete,items:items}}))};return CompletionAdapter}();exports.CompletionAdapter=CompletionAdapter;function isMarkupContent(thing){return thing&&typeof thing==="object"&&typeof thing.kind==="string"}function toMarkdownString(entry){if(typeof entry==="string"){return{value:entry}}if(isMarkupContent(entry)){if(entry.kind==="plaintext"){return{value:entry.value.replace(/[\\`*_{}[\]()#+\-.!]/g,"\\$&")}}return{value:entry.value}}return{value:"```"+entry.language+"\n"+entry.value+"\n```\n"}}function toMarkedStringArray(contents){if(!contents){return void 0}if(Array.isArray(contents)){return contents.map(toMarkdownString)}return[toMarkdownString(contents)]}var HoverAdapter=function(){function HoverAdapter(_worker,options){this._worker=_worker;this.options=options}HoverAdapter.prototype.provideHover=function(model,position,token){var _this=this;var resource=model.uri;return wireCancellationToken(token,this._worker(resource).then(function(worker){return worker.doHover(resource.toString(),fromPosition(position),_this.options)}).then(function(info){return __awaiter(_this,void 0,void 0,function(){var contents,data;return __generator(this,function(_a){switch(_a.label){case 0:if(!info){return[2]}contents="";if(!(info.type===definitions_1.IType.UDF&&info.contents&&this.options.onHover))return[3,2];return[4,this.options.onHover(info.type,info.contents)];case 1:data=_a.sent()||{};contents="名称: "+data.name+"，\n\n命令格式："+data.commandHelp+"，\n\n使用文档：\n\n    "+data.description.split("↵").map(function(item){return item.trim()}).filter(function(item){return item}).join("    \n\n")+"\n\t\t\t\t";_a.label=2;case 2:return[2,{range:toRange(info.range),contents:toMarkedStringArray(contents)}]}})})}))};return HoverAdapter}();exports.HoverAdapter=HoverAdapter;var FormatterAdapter=function(){function FormatterAdapter(_worker){this._worker=_worker}FormatterAdapter.prototype.provideDocumentFormattingEdits=function(model,options,token){var resource=model.uri;return wireCancellationToken(token,this._worker(resource).then(function(worker){return worker.format(resource.toString())}).then(function(formatted){return formatted.map(function(item){return{range:{startLineNumber:0,startColumn:0,endLineNumber:1e4,endColumn:1e4},text:item.newText}})}))};return FormatterAdapter}();exports.FormatterAdapter=FormatterAdapter;var DocumentColorAdapter=function(){function DocumentColorAdapter(_worker){this._worker=_worker}DocumentColorAdapter.prototype.provideDocumentColors=function(model,token){var resource=model.uri;return wireCancellationToken(token,this._worker(resource).then(function(worker){return worker.findDocumentColors(resource.toString())}).then(function(infos){if(!infos){return}return infos.map(function(item){return{color:item.color,range:{startLineNumber:0,startColumn:0,endLineNumber:1e4,endColumn:1e4}}})}))};DocumentColorAdapter.prototype.provideColorPresentations=function(model,info,token){var resource=model.uri;return wireCancellationToken(token,this._worker(resource).then(function(worker){return worker.getColorPresentations(info.color,fromRange(info.range))}).then(function(presentations){if(!presentations){return}return[{label:"one",color:{red:1,blue:0,green:0,alpha:1},range:{startLineNumber:1,startColumn:0,endLineNumber:1,endColumn:0}},{label:"two",color:{red:0,blue:1,green:0,alpha:1},range:{startLineNumber:2,startColumn:0,endLineNumber:2,endColumn:0}},{label:"three",color:{red:0,blue:0,green:1,alpha:1},range:{startLineNumber:3,startColumn:0,endLineNumber:3,endColumn:0}}]}))};return DocumentColorAdapter}();exports.DocumentColorAdapter=DocumentColorAdapter;function wireCancellationToken(token,promise){token.onCancellationRequested(function(){return promise.cancel()});return promise}});