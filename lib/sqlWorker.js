var __assign=this&&this.__assign||Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var __generator=this&&this.__generator||function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=y[op[0]&2?"return":op[0]?"throw":"next"])&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[0,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};define(["require","exports","vscode-languageserver-types","lodash","sql-formatter","@ali/intellij-parser","./tools/autofix/SymSpell","./tools/autofix/sqlDict","./definitions"],function(require,exports,ls,_,sqlFormatter,intellij_parser_1,SymSpell_1,sqlDict_1,definitions_1){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Promise=monaco.Promise;var checkValues=function(visitedTable,query,typeCheck){if(typeCheck){return _.find(visitedTable,function(item){return item.name===query&&item.sqlType===typeCheck})}return _.find(visitedTable,function(item){return item.name===query})};var LanguageMap={ODPSSQL:intellij_parser_1.ODPS,HiveSQL:intellij_parser_1.Hive,Shell:intellij_parser_1.Shell};var DataLean=[];var SQLWorker=function(){function SQLWorker(ctx,createData){this._ctx=ctx;this.languageId=createData.languageId;this.utils=LanguageMap[createData.languageId].utils;this.parser=LanguageMap[createData.languageId].parser;this.getAvailableTokens=LanguageMap[createData.languageId].getAvailableTokens}SQLWorker.prototype.getWhereClauseInfo=function(item){var _this=this;var conditions=[];var whereClause=_.findLast(item.ruleStack,{name:definitions_1.SyntaxKind.fromClause}).children[definitions_1.SyntaxKind.whereClause];if(whereClause){this.utils.getFilteredNode(whereClause[0],function(target){return target.name===definitions_1.SyntaxKind.expressionRecursionPart},true).map(function(item){var condition={};_this.utils.getFilteredNode(item,function(atom){if(atom.name===definitions_1.SyntaxKind.expressionAtom){if(condition.left){condition.right=_this.utils.getFilteredNode(atom,function(target){return target.image},true).map(function(item){return item.image}).join("")}else{condition.left=_this.utils.getFilteredNode(atom,function(target){return target.image},true).map(function(item){return item.image}).join("")}}if(atom.name===definitions_1.SyntaxKind.comparisonOperator){condition.operator=_this.utils.getFilteredNode(atom,function(target){return target.image})[0].image}},true);conditions.push(condition)})}return conditions};SQLWorker.prototype.doValidation=function(uri,isBatch){return __awaiter(this,void 0,void 0,function(){var _this=this;var document,ast,errorCase_1,tableSrcList_1,fieldList_1,formattedTableSrcList_1,errorList;return __generator(this,function(_a){switch(_a.label){case 0:document=this._getTextDocument(uri).document;if(!false)return[3,2];ast=this.parser(document.getText());errorCase_1=[{table:"stg_s_od_his_customer",column:"c_id",minPartition:20190101,maxPartition:20190101,partitionName:"ds"},{table:"stg_s_od_his_account",column:"ca_id",minPartition:20190101,maxPartition:20190101,partitionName:"ds"}];tableSrcList_1=[];fieldList_1=[];this.utils.getFilteredNode(ast.cst,function(target){if(target.children&&target.children[definitions_1.SyntaxKind.joinPart]){tableSrcList_1.push({target:target.children[definitions_1.SyntaxKind.tableSourceItem][0],ruleStack:target.ruleStack})}if(target.name===definitions_1.SyntaxKind.joinPart){if(target.children[definitions_1.SyntaxKind.tableSourceItem]){tableSrcList_1.push({target:target.children[definitions_1.SyntaxKind.tableSourceItem][0],ruleStack:target.ruleStack})}if(target.children[definitions_1.SyntaxKind.expression]){fieldList_1=fieldList_1.concat(_this.utils.getFilteredNode(target.children[definitions_1.SyntaxKind.expression][0],function(childTarget){return childTarget.name===definitions_1.SyntaxKind.fullColumnName},true))}}},true);formattedTableSrcList_1=_.flatten(tableSrcList_1).map(function(item){var table=item.target;if(table.children[definitions_1.SyntaxKind.tableName]){var tableName=_this.utils.getFilteredNode(table.children[definitions_1.SyntaxKind.tableName][0],function(target){return target.image},true);var conditions=_this.getWhereClauseInfo(item);return{table:tableName.map(function(slice){return slice.image}).join(""),conditions:conditions,alias:_.get(_this.utils.getFilteredNode(_.get(table.children[definitions_1.SyntaxKind.uid],"[0]",{}),function(target){return target.image})[0],"image")}}});fieldList_1=fieldList_1.map(function(item){var idList=_this.utils.getFilteredNode(item,function(target){return target.image},true);var lastPart=idList[idList.length-1];var range={start:{line:_.get(idList[0],"startLine",0)-1,character:_.get(idList[0],"startColumn",0)-1},end:{line:_.get(lastPart,"startLine",0)-1,character:_.get(lastPart,"startColumn",0)-1+_.get(lastPart,"image.length",0)}};var tableName=idList.map(function(item){return item.image}).slice(0,-1).join("");var column=idList.map(function(item){return item.image}).slice(-1)[0]||"";return __assign({},_.find(formattedTableSrcList_1,function(item){return item.table===tableName||item.alias===tableName}),{column:column.indexOf(".")===0?column.slice(1):column,range:range})});return[4,Promise.join(_.difference(fieldList_1,DataLean).map(function(item){return Promise.as(__assign({},item,{isLeaned:_.find(errorCase_1,function(err){var conditionMatched=_.find(item.conditions,function(condition){return condition.left.split(".").pop()===err.partitionName&&condition.operator==="="&&+condition.right===err.minPartition});return err.table===item.table&&err.column===item.column&&conditionMatched})}))}))];case 1:errorList=_a.sent();DataLean=fieldList_1;return[2,Promise.as(_.filter(errorList.map(function(item){if(item.isLeaned){return{message:"数据倾斜预警！！\n\n物理表："+item.table+"\n\n字段："+item.column+"\n\n分区值："+item.isLeaned.partitionName+" = "+item.isLeaned.minPartition,severity:1,range:item.range}}}),function(item){return item}))];case 2:return[2,Promise.as([{message:"",severity:ls.DiagnosticSeverity.Error,range:{start:{line:-1,character:-1},end:{line:-1,character:-1}}}])]}})})};SQLWorker.prototype.getNestedFields=function(availableFields){var _this=this;return availableFields.map(function(item){if(Array.isArray(item)){return _this.getNestedFields(item[0].exportsFields)}else{return item}})};SQLWorker.prototype.deepFind=function(aliasMap,filter){var _this=this;return _.filter(_.flatten(aliasMap.map(function(item){if(filter(item)){return item}else if(Array.isArray(item.exportsFields[0])){return _.flatten(item.exportsFields.map(function(subItem){return _this.deepFind(subItem,filter)}))}else{return}})),function(o){return o})};SQLWorker.prototype.complementedInsertText=function(item,completionTypes,autoPrefix){if(autoPrefix===void 0){autoPrefix=true}var needPrefix=["LOGIC_MODEL_SUMMARY","LOGIC_MODEL_FACT","LOGIC_MODEL_DIM","PHYSICAL_TABLE_ONLINE","SAMPLE_TYPE_ONE"];var needBrackets=["FUNCTION","FUNCTION-HADOOP","FUNCTION-MAX_COMPUTE"];if(needPrefix.includes(item.type)&&autoPrefix){return{insertText:""+(item.parentEntityName?item.parentEntityName+".":"")+item.name,detail:completionTypes[item.type].text,kind:completionTypes[item.type].kind,documentation:item.nameCn||item.des}}if(needBrackets.includes(item.type)){return{insertText:{value:item.name+"($0)"},detail:completionTypes[item.type].text,kind:completionTypes[item.type].kind,documentation:item.nameCn||item.des}}return{insertText:item.name,detail:completionTypes[item.type].text,kind:completionTypes[item.type].kind,documentation:item.nameCn||item.des}};SQLWorker.prototype.getCompletePath=function(node){return _.orderBy(this.utils.getFilteredNode(node,function(target){return target.image},true),["startOffset"],["asc"]).map(function(item){return item.image}).join("")};SQLWorker.prototype.getAsyncCompleteInfo=function(err,ast,aliasMap,Global,visitedTable,request,completionTypes,position){return __awaiter(this,void 0,void 0,function(){var _this=this;var tables,fields,HotWords,targetNode,keyword,fulltableNameNode_1,sqlType,sqlTypeStack,cachedTable,e_1,parentNode,length_1,i,completePath,cachedTable,e_2,tableSrc,query,cachedTable,e_3,columnPath,originPath_1,aliasPath_1,lastTableInfo,fieldsList,_a,_b,query,cachedTable,e_4,finalPath_1,cachedTable,tableSrc,e_5;return __generator(this,function(_c){switch(_c.label){case 0:tables={};fields={};HotWords=Global.HotWords;targetNode=this.utils.getPositiondNode(ast.cst,{line:position.line+1,offset:position.character})[0];if(!(targetNode.name===definitions_1.SyntaxKind.tableSourceItem||_.find(targetNode.ruleStack,{name:definitions_1.SyntaxKind.tableName})))return[3,5];keyword="";fulltableNameNode_1=_.find(targetNode.ruleStack,{name:definitions_1.SyntaxKind.tableName});if(fulltableNameNode_1){keyword=this.getCompletePath(fulltableNameNode_1)}sqlType=void 0;sqlTypeStack=_.find(targetNode.ruleStack,function(stack){return stack.name===definitions_1.SyntaxKind.dmlStatement||stack.name===definitions_1.SyntaxKind.ddlStatement||stack.name===definitions_1.SyntaxKind.dqlStatement});if(sqlTypeStack.name===definitions_1.SyntaxKind.dmlStatement){if(_.find(targetNode.ruleStack,{name:definitions_1.SyntaxKind.selectStatement})){sqlType=definitions_1.SQLType.DQL}else{sqlType=definitions_1.SQLType.DML}}else if(sqlTypeStack.name===definitions_1.SyntaxKind.ddlStatement){sqlType=definitions_1.SQLType.DDL}else if(sqlTypeStack.name===definitions_1.SyntaxKind.dqlStatement){sqlType=definitions_1.SQLType.DQL}cachedTable=checkValues(visitedTable,keyword,sqlType);if(cachedTable){return[2,Promise.as((cachedTable.data||[]).map(function(table){return definitions_1.generateCompleteItem(table.name,HotWords,_this.complementedInsertText(table,completionTypes,!fulltableNameNode_1))}))]}_c.label=1;case 1:_c.trys.push([1,3,,4]);return[4,request(keyword,sqlType)];case 2:tables=_c.sent();return[3,4];case 3:e_1=_c.sent();throw new Error(e_1);case 4:if(_.get(tables,"data.allEntities")){visitedTable.push({name:keyword,sqlType:sqlType,data:_.get(tables,"data.entities")})}return[2,(_.get(tables,"data.entities")||[]).map(function(table){return definitions_1.generateCompleteItem(table.name,HotWords,_this.complementedInsertText(table,completionTypes,!fulltableNameNode_1))})];case 5:parentNode=void 0;length_1=targetNode.ruleStack.length;for(i=length_1-1;i>=0;i--){if(targetNode.ruleStack[i].name===definitions_1.SyntaxKind.joinPart){parentNode=_.findLast(targetNode.ruleStack.slice(0,i),{name:definitions_1.SyntaxKind.fromClause});break}parentNode=this.utils.getFilteredNode(targetNode.ruleStack[i],function(target){return target.name===definitions_1.SyntaxKind.fromClause||target.name===definitions_1.SyntaxKind.tableName})[0];if(targetNode.ruleStack[i].name===definitions_1.SyntaxKind.selectStatement){break}if(parentNode){break}}if(!!parentNode)return[3,6];return[2,[]];case 6:if(!(parentNode.name===definitions_1.SyntaxKind.tableName))return[3,11];completePath=this.getCompletePath(parentNode)+".";cachedTable=checkValues(visitedTable,completePath);if(cachedTable){return[2,Promise.as((cachedTable.data||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))}))]}_c.label=7;case 7:_c.trys.push([7,9,,10]);return[4,request(completePath)];case 8:fields=_c.sent();return[3,10];case 9:e_2=_c.sent();throw new Error(e_2);case 10:if(_.get(fields,"data.allEntities")){visitedTable.push({name:completePath,data:_.get(fields,"data.entities")})}return[2,(_.get(fields,"data.entities")||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))})];case 11:if(!(targetNode.children&&_.isEmpty(targetNode.children)))return[3,17];tableSrc=parentNode.children[definitions_1.TokenLabel.FROM]?this.utils.getNextTableSource(ast,parentNode.children[definitions_1.TokenLabel.FROM][0],true):[];if(!(tableSrc.length===1&&!tableSrc[0].alias))return[3,16];query=tableSrc[0].table+".";cachedTable=checkValues(visitedTable,query);if(cachedTable){return[2,Promise.as((cachedTable.data||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))}))]}_c.label=12;case 12:_c.trys.push([12,14,,15]);return[4,request(query)];case 13:fields=_c.sent();return[3,15];case 14:e_3=_c.sent();throw new Error(e_3);case 15:if(_.get(fields,"data.allEntities")){visitedTable.push({name:query,data:_.get(fields,"data.entities")})}return[2,(_.get(fields,"data.entities")||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))})];case 16:return[2,tableSrc.map(function(table){if(table.table!=="SUBQUERY"&&!table.alias){return definitions_1.generateCompleteItem(table.table,HotWords,{detail:"表名",kind:definitions_1.CompletionItemKind.Alias})}return definitions_1.generateCompleteItem(table.alias,HotWords,{detail:"表别名",kind:definitions_1.CompletionItemKind.Alias})})];case 17:columnPath=this.utils.getTotalPath(ast.cst,targetNode);if(columnPath.slice(-1)==="."){columnPath=columnPath.slice(0,-1)}originPath_1=columnPath.split(".");aliasPath_1=[];originPath_1.forEach(function(item){aliasPath_1.push(_this.deepFind(aliasMap,function(o){return o.alias===item||o.table===item})[0]||{})});lastTableInfo=aliasPath_1.slice(-1)[0];if(!(lastTableInfo.table==="SUBQUERY"))return[3,19];fieldsList=_.flattenDeep(this.getNestedFields(lastTableInfo.availableFields));_b=(_a=_).flattenDeep;return[4,Promise.join(fieldsList.map(function(field){return __awaiter(_this,void 0,void 0,function(){var _this=this;var query,cachedTable,e_6;return __generator(this,function(_a){switch(_a.label){case 0:if(!(field.name==="*"))return[3,5];query=""+field.origin+targetNode.image;cachedTable=checkValues(visitedTable,query);if(cachedTable){return[2,Promise.as((cachedTable.data||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))}))]}_a.label=1;case 1:_a.trys.push([1,3,,4]);return[4,request(query)];case 2:fields=_a.sent();return[3,4];case 3:e_6=_a.sent();throw new Error(e_6);case 4:if(_.get(fields,"data.allEntities")){visitedTable.push({name:query,data:_.get(fields,"data.entities")})}return[2,(_.get(fields,"data.entities")||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))})];case 5:if(field.alias){return[2,Promise.as([definitions_1.generateCompleteItem(field.alias,HotWords,{detail:"表字段别名",kind:definitions_1.CompletionItemKind.Alias})])]}else{return[2,Promise.as([definitions_1.generateCompleteItem(field.name,HotWords,{detail:"表字段"})])]}return[2]}})})}))];case 18:return[2,_b.apply(_a,[_c.sent()])];case 19:if(!!_.isEmpty(lastTableInfo))return[3,26];if(!(lastTableInfo.availableFields[0].name==="*"))return[3,24];query=lastTableInfo.table+".";cachedTable=checkValues(visitedTable,query);if(cachedTable){return[2,Promise.as((cachedTable.data||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))}))]}_c.label=20;case 20:_c.trys.push([20,22,,23]);return[4,request(query)];case 21:fields=_c.sent();return[3,23];case 22:e_4=_c.sent();throw new Error(e_4);case 23:if(_.get(fields,"data.allEntities")){visitedTable.push({name:query,data:_.get(fields,"data.entities")})}return[2,(_.get(fields,"data.entities")||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))})];case 24:return[2,_.flatten(lastTableInfo.availableFields.map(function(field){if(field.alias){return Promise.as([definitions_1.generateCompleteItem(field.alias,HotWords,{detail:"表字段别名"})])}else{return Promise.as([definitions_1.generateCompleteItem(field.name,HotWords,{detail:"表字段"})])}}))];case 25:return[3,31];case 26:finalPath_1="";aliasPath_1.forEach(function(item,idx){if(!_.isEmpty(item)&&item.alias){finalPath_1+=item.table+"."}else{finalPath_1+=originPath_1[idx]+"."}});finalPath_1=finalPath_1.slice(0,-1);if(targetNode.image==="."){finalPath_1+="."}cachedTable=checkValues(visitedTable,finalPath_1);if(cachedTable){return[2,Promise.as((cachedTable.data||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))}))]}if(originPath_1.length===1){tableSrc=this.utils.getNextTableSource(ast,parentNode.children[definitions_1.TokenLabel.FROM][0],true);finalPath_1=tableSrc[0].table+"."+finalPath_1}_c.label=27;case 27:_c.trys.push([27,29,,30]);return[4,request(finalPath_1)];case 28:fields=_c.sent();return[3,30];case 29:e_5=_c.sent();throw new Error(e_5);case 30:if(_.get(fields,"data.allEntities")){visitedTable.push({name:finalPath_1,data:_.get(fields,"data.entities")})}return[2,(_.get(fields,"data.entities")||[]).map(function(field){return definitions_1.generateCompleteItem(field.name,HotWords,_this.complementedInsertText(field,completionTypes))})];case 31:return[2]}})})};SQLWorker.prototype.getSyncCompleteInfo=function(err,HotWords,TokenEnum){if(err===definitions_1.TokenLabel.CHARSET_NAME_L||err===definitions_1.TokenLabel.CHARSET_REVERSE_QOUTE_STRING||err===definitions_1.TokenLabel.STRING_CHARSET_NAME){return Object.keys(definitions_1.Charset).map(function(char){return definitions_1.generateCompleteItem(char,HotWords,{detail:"常量",kind:definitions_1.CompletionItemKind.Enum})})}else if(definitions_1.IgnoreLabel[err]||definitions_1.EscapeLabel[err]){return[]}else if(definitions_1.DefaultFunc[err]){return[definitions_1.generateCompleteItem(definitions_1.DefaultFunc[err],HotWords,{detail:"函数",kind:definitions_1.CompletionItemKind.OdpsFunction})]}else{return[definitions_1.generateCompleteItem(definitions_1.TokenLabel[err]||TokenEnum[err],HotWords,{detail:"关键词",kind:definitions_1.CompletionItemKind.Keyword})]}};SQLWorker.prototype.transformOptions=function(options){var final={};if(options.query){if(options.query.url==="mock"){final.request=function(){return Promise.as({data:{allEntities:true,entities:[{name:"sampleOne",des:"样例数据，补充前缀场景",parentEntityName:"prefix_will_be_insert",type:"SAMPLE_TYPE_ONE"},{name:"sampleTwo",des:"样例数据，无前缀场景",parentEntityName:"prefix_will_not_be_insert",type:"SAMPLE_TYPE_TWO"}]}})}}else{var completeUrl_1=options.query.url+"?";Object.entries(options.query.params).forEach(function(_a){var key=_a[0],value=_a[1];completeUrl_1+=key+"="+value+"&"});final.request=function(keyword,sqlType){if(sqlType===void 0){sqlType=definitions_1.SQLType.DQL}return fetch(completeUrl_1+"keyword="+(keyword||"")+"&sqlType="+sqlType,{credentials:"include"}).then(function(data){return data.json()})}}}return final};SQLWorker.prototype.positionKeyWord=function(text,position){var currLine=text.split("\n")[position.line];var startPos=-1;var endPos=currLine.length;for(var start=position.character-1;start>=-1;start--){if(currLine[start]===" "){startPos=start;break}}for(var end=position.character-1;end<=currLine.length-1;end++){if(currLine[end]===" "){endPos=end;break}}return{keyword:currLine.slice(startPos+1,endPos),current:currLine[position.character-1],startPos:startPos<0?startPos:startPos+1,endPos:endPos}};SQLWorker.prototype.triggerAutofix=function(preKeyword){var normalized=preKeyword.toLowerCase().trim();var specialLetter=[",",".","(",")","-"];if(_.union(normalized.split(""),specialLetter).length===_.uniq(normalized.split("")).length+specialLetter.length){var spellFixer=new SymSpell_1.SymSpell(undefined,{dictionary:sqlDict_1.dictionary,wordList:sqlDict_1.wordList,maxLength:sqlDict_1.maxLength});var suggestions=spellFixer.correct(normalized,"");if(suggestions.length&&suggestions[0].term){if(normalized.length===4&&suggestions[0].distance<=1||normalized.length>4){return suggestions[0].term}}}return false};SQLWorker.prototype.doComplete=function(uri,position,languageId,Global,visitedTable,options){return __awaiter(this,void 0,void 0,function(){var _this=this;var document,text,final,_a,keyword,current,fixedValue,tables,e_7,_b,preKeyword,startPos,endPos,suggestion,ast,alias,flatternError,CompletionItem,errors,completeErrors,targetError,targetErrorPos,minDistance,hasId,_c,_d,_e;return __generator(this,function(_f){switch(_f.label){case 0:document=this._getTextDocument(uri).document;text=document.getText();final=this.transformOptions(options);_a=this.positionKeyWord(text,position),keyword=_a.keyword,current=_a.current;fixedValue=null;if(!options.degenerate)return[3,5];tables={};_f.label=1;case 1:_f.trys.push([1,3,,4]);return[4,final.request(keyword,definitions_1.SQLType.DQL)];case 2:tables=_f.sent();return[3,4];case 3:e_7=_f.sent();throw new Error(e_7);case 4:return[2,Promise.as({isIncomplete:true,visitedTable:visitedTable,fixedValue:fixedValue,items:(_.get(tables,"data.entities")||[]).map(function(table){return definitions_1.generateCompleteItem(table.name,[],_this.complementedInsertText(table,options.completionTypes,false))})})];case 5:if(options.autofix){_b=this.positionKeyWord(text,__assign({},position,{character:position.character-1})),preKeyword=_b.keyword,startPos=_b.startPos,endPos=_b.endPos;if(current===" "&&preKeyword!==" "){suggestion=this.triggerAutofix(preKeyword);if(suggestion){fixedValue={startLineNumber:position.line,startColumn:startPos,endLineNumber:position.line,endColumn:endPos,text:preKeyword[0]>="a"?suggestion.toLowerCase():suggestion.toUpperCase()}}}}ast=this.parser(text);alias=this.utils.getAliasMap(ast);flatternError=[];CompletionItem=[];errors=this.utils.getCompleteInfo(ast,position,languageId);completeErrors=this.getAvailableTokens(document.getText({start:{line:0,character:0},end:position}));targetError=null;targetErrorPos=0;minDistance=1e4;errors.forEach(function(err,idx){if(!err.previousToken){targetError=err}else{var newDistance=position.character+1-err.previousToken.startColumn-err.previousToken.image.length;if(newDistance<minDistance&&newDistance>=0){minDistance=newDistance;targetErrorPos=idx;targetError=err}}});targetError&&targetError.completeType.forEach(function(err,idx){if(err.errType.split(", ").length>1){err.errType.split(", ").forEach(function(type){flatternError.push(__assign({},err,{errType:type}))})}else if(Object.keys(definitions_1.selectSpec).concat(Global.TokenEnum.SELECT).includes(_.get(errors[targetErrorPos-1],"previousToken.image","").toUpperCase())&&targetError.completeType.length===1&&targetError.completeType[0].errType===Global.TokenEnum.SEMI){flatternError.push({errType:definitions_1.TokenLabel.ID})}else{flatternError.push(err)}});flatternError=_.uniq(flatternError.map(function(err){return err.errType}).concat(completeErrors));hasId=flatternError.find(function(item){return item===definitions_1.TokenLabel.ID||item===definitions_1.TokenLabel.DOT_ID});if(!hasId)return[3,7];_d=(_c=CompletionItem.push).apply;_e=[CompletionItem];return[4,this.getAsyncCompleteInfo(hasId,ast,alias,Global,visitedTable,final.request,options.completionTypes,position)];case 6:_d.apply(_c,_e.concat([_f.sent()]));_f.label=7;case 7:flatternError.forEach(function(err){if(err!==definitions_1.TokenLabel.ID&&err!==definitions_1.TokenLabel.DOT_ID&&err!=="DOT"){CompletionItem.push.apply(CompletionItem,_this.getSyncCompleteInfo(err,Global.HotWords,Global.TokenEnum))}});return[2,Promise.as({isIncomplete:hasId?true:false,fixedValue:fixedValue,visitedTable:visitedTable,items:CompletionItem})]}})})};SQLWorker.prototype.doHover=function(uri,position,options){var document=this._getTextDocument(uri).document;var ast=this.parser(document.getText());var contents=undefined;var type=undefined;var endColumn=0;var target=this.utils.getClassification(ast,position)[0];var startLine=target.startLine,startColumn=target.startColumn;var targetNode=this.utils.getPositiondNode(ast.cst,{line:position.line+1,offset:position.character})[0];var ifFunc=_.find(targetNode.ruleStack,{name:definitions_1.SyntaxKind.functionCall});if(ifFunc){if(ifFunc.children[definitions_1.SyntaxKind.customFunction]){var UDFSlices=this.utils.getFilteredNode(ifFunc.children[definitions_1.SyntaxKind.customFunction][0].children[definitions_1.SyntaxKind.fullId][0],function(target){return target.image},true);type=definitions_1.IType.UDF;var target_1=_.find(_.get(options,"udf"),{name:UDFSlices.map(function(slice){return slice.image}).join("")});contents=_.get(target_1,"id");endColumn=_.get(target_1,"name.length")+startColumn+2}else{}}return Promise.as({range:{start:{line:startLine-1,character:startColumn},end:{line:startLine-1,character:endColumn}},type:type,contents:contents})};SQLWorker.prototype.format=function(uri,range,options){var document=this._getTextDocument(uri).document;var textEdits=sqlFormatter.format(document.getText());return Promise.as([{range:null,newText:textEdits}])};SQLWorker.prototype.findDocumentColors=function(uri,stylesheet){return[{range:null,color:{red:0,blue:0,green:255,alpha:1}}]};SQLWorker.prototype.getColorPresentations=function(color,range){var result=[];var red256=Math.round(color.red*255),green256=Math.round(color.green*255),blue256=Math.round(color.blue*255);var label;if(color.alpha===1){label="rgb("+red256+", "+green256+", "+blue256+")"}else{label="rgba("+red256+", "+green256+", "+blue256+", "+color.alpha+")"}result.push({label:label,textEdit:ls.TextEdit.replace(range,label)});if(color.alpha===1){label="#"+this._toTwoDigitHex(red256)+this._toTwoDigitHex(green256)+this._toTwoDigitHex(blue256)}else{label="#"+this._toTwoDigitHex(red256)+this._toTwoDigitHex(green256)+this._toTwoDigitHex(blue256)+this._toTwoDigitHex(Math.round(color.alpha*255))}result.push({label:label,textEdit:ls.TextEdit.replace(range,label)});var hsl=this._hslFromColor(color);if(hsl.a===1){label="hsl("+hsl.h+", "+Math.round(hsl.s*100)+"%, "+Math.round(hsl.l*100)+"%)"}else{label="hsla("+hsl.h+", "+Math.round(hsl.s*100)+"%, "+Math.round(hsl.l*100)+"%, "+hsl.a+")"}result.push({label:label,textEdit:ls.TextEdit.replace(range,label)});return result};SQLWorker.prototype._getTextDocument=function(uri){var models=this._ctx.getMirrorModels();for(var _i=0,models_1=models;_i<models_1.length;_i++){var model=models_1[_i];if(model.uri.toString()===uri){return{document:ls.TextDocument.create(uri,this.languageId,model.version,model.getValue()),model:model}}}return{}};SQLWorker.prototype._toTwoDigitHex=function(n){var r=n.toString(16);return r.length!==2?"0"+r:r};SQLWorker.prototype._hslFromColor=function(rgba){var r=rgba.red;var g=rgba.green;var b=rgba.blue;var a=rgba.alpha;var max=Math.max(r,g,b);var min=Math.min(r,g,b);var h=0;var s=0;var l=(min+max)/2;var chroma=max-min;if(chroma>0){s=Math.min(l<=.5?chroma/(2*l):chroma/(2-2*l),1);switch(max){case r:h=(g-b)/chroma+(g<b?6:0);break;case g:h=(b-r)/chroma+2;break;case b:h=(r-g)/chroma+4;break}h*=60;h=Math.round(h)}return{h:h,s:s,l:l,a:a}};return SQLWorker}();exports.SQLWorker=SQLWorker;function create(ctx,createData){return new SQLWorker(ctx,createData)}exports.create=create});