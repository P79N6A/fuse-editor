var __assign=this&&this.__assign||Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};define(["require","exports","vscode-languageserver-types","lodash","@ali/intellij-parser","./tools/autofix/SymSpell","./tools/autofix/shellDict","./definitions"],function(require,exports,ls,_,intellij_parser_1,SymSpell_1,shellDict_1,definitions_1){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Promise=monaco.Promise;var LanguageMap={ODPSSQL:intellij_parser_1.ODPS,HiveSQL:intellij_parser_1.Hive,Shell:intellij_parser_1.Shell};var ShellWorker=function(){function ShellWorker(ctx,createData){this._ctx=ctx;this.languageId=createData.languageId;this.utils=LanguageMap[createData.languageId].utils;this.parser=LanguageMap[createData.languageId].parser;this.getAvailableTokens=LanguageMap[createData.languageId].getAvailableTokens}ShellWorker.prototype.doValidation=function(uri){var _this=this;var document=this._getTextDocument(uri).document;var ast=this.parser(document.getText());var nodeList=this.utils.getFilteredNode(ast.cst,function(target){return target.children&&target.children[definitions_1.SyntaxKind.cliOpt]},true);var errList=nodeList.map(function(item){var inputOptions=_this.utils.getFilteredNode(item.children[definitions_1.SyntaxKind.cliOpt][0],function(target){return target.image})[0];if(inputOptions&&!_.isEmpty(inputOptions)){var checkResult=inputOptions.image.split("").filter(function(opt){return opt!=="-"}).some(function(opt){return!definitions_1.CLIDict[item.name].validOption.includes(opt)});if(checkResult){var message=item.name.slice(0,-3)+"参数错误!!\n\n参数说明：\n\n";message+=definitions_1.CLIDict[item.name].desc;return{message:message,severity:1,range:{start:{line:inputOptions.startLine-1,character:inputOptions.startColumn-1},end:{line:inputOptions.startLine-1,character:inputOptions.startColumn+_.get(inputOptions,"image.length",0)-1}}}}}return undefined});errList.push.apply(errList,ast.parseErrors.map(function(item){var linuxCmdPos=_.findIndex(item.context.ruleStack,function(o){return o===definitions_1.SyntaxKind.linuxCommand});if(linuxCmdPos>-1&&item.name==="NoViableAltException"){if(_.find(item.message.match(/\[.*?\]/g),function(o){return o.match(/CLI_/)})){var cmdName=item.context.ruleStack[linuxCmdPos+2];var message=cmdName.slice(0,-3)+"参数错误!!\n\n参数说明：\n\n"+definitions_1.CLIDict[cmdName].modDesc;return{message:message,severity:1,range:{start:{line:item.token.startLine-1,character:item.token.startColumn-1},end:{line:item.token.startLine-1,character:item.token.startColumn+_.get(item.token,"image.length",0)-1}}}}}return undefined}));return Promise.as(_.filter(errList,function(o){return o}))};ShellWorker.prototype.getSyncCompleteInfo=function(err,HotWords,TokenEnum){if(definitions_1.IgnoreLabel[err]||definitions_1.EscapeLabel[err]){return[]}else{return TokenEnum[err]?[definitions_1.generateCompleteItem(TokenEnum[err],HotWords,{detail:"关键词",kind:definitions_1.CompletionItemKind.Keyword})]:[]}};ShellWorker.prototype.positionKeyWord=function(text,position){var currLine=text.split("\n")[position.line];var startPos=-1;var endPos=currLine.length;for(var start=position.character-1;start>=-1;start--){if(currLine[start]===" "){startPos=start;break}}for(var end=position.character-1;end<=currLine.length-1;end++){if(currLine[end]===" "){endPos=end;break}}return{keyword:currLine.slice(startPos+1,endPos),current:currLine[position.character-1],startPos:startPos<0?startPos:startPos+1,endPos:endPos}};ShellWorker.prototype.triggerAutofix=function(preKeyword){var normalized=preKeyword.toLowerCase().trim();var specialLetter=[",",".","(",")","-"];if(_.union(normalized.split(""),specialLetter).length===_.uniq(normalized.split("")).length+specialLetter.length){var spellFixer=new SymSpell_1.SymSpell(undefined,{dictionary:shellDict_1.dictionary,wordList:shellDict_1.wordList,maxLength:shellDict_1.maxLength});var suggestions=spellFixer.correct(normalized,"");if(suggestions.length&&suggestions[0].term){if(normalized.length>2&&normalized.length<=4&&suggestions[0].distance<=1||normalized.length>4||normalized.length<=2&&!suggestions[0].distance){return suggestions[0].term}}}return false};ShellWorker.prototype.doComplete=function(uri,position,languageId,Global,visitedTable,options){var _this=this;var document=this._getTextDocument(uri).document;var text=document.getText();var current=this.positionKeyWord(text,position).current;var fixedValue=null;if(options.autofix){var _a=this.positionKeyWord(text,__assign({},position,{character:position.character-1})),preKeyword=_a.keyword,startPos=_a.startPos,endPos=_a.endPos;if(current===" "&&preKeyword!==" "){var suggestion=this.triggerAutofix(preKeyword);if(suggestion){fixedValue={startLineNumber:position.line,startColumn:startPos,endLineNumber:position.line,endColumn:endPos,text:preKeyword[0]>="a"?suggestion.toLowerCase():suggestion.toUpperCase()}}}}var ast=this.parser(text);var flatternError=[];var CompletionItem=[];var errors=this.utils.getCompleteInfo(ast,position,languageId);var completeErrors=this.getAvailableTokens(document.getText({start:{line:0,character:0},end:position}));var targetError=null;var targetErrorPos=0;var minDistance=1e4;errors.forEach(function(err,idx){if(!err.previousToken){targetError=err}else{var newDistance=position.character+1-err.previousToken.startColumn-err.previousToken.image.length;if(newDistance<minDistance&&newDistance>=0){minDistance=newDistance;targetErrorPos=idx;targetError=err}}});targetError&&targetError.completeType.forEach(function(err,idx){if(err.errType.split(", ").length>1){err.errType.split(", ").forEach(function(type){flatternError.push(__assign({},err,{errType:type}))})}else{flatternError.push(err)}});flatternError=_.uniq(flatternError.map(function(err){return err.errType}).concat(completeErrors));flatternError.forEach(function(err){CompletionItem.push.apply(CompletionItem,_this.getSyncCompleteInfo(err,Global.HotWords,Global.TokenEnum))});return Promise.as({isIncomplete:false,fixedValue:fixedValue,items:[]})};ShellWorker.prototype.doHover=function(uri,position,options){var document=this._getTextDocument(uri).document;var contents=undefined;var type=undefined;return Promise.as({range:{start:{line:0,character:0},end:{line:0,character:0}},type:type,contents:contents})};ShellWorker.prototype.format=function(uri,range,options){var document=this._getTextDocument(uri).document;return Promise.as([{range:null,newText:document.getText()}])};ShellWorker.prototype._getTextDocument=function(uri){var models=this._ctx.getMirrorModels();for(var _i=0,models_1=models;_i<models_1.length;_i++){var model=models_1[_i];if(model.uri.toString()===uri){return{document:ls.TextDocument.create(uri,this.languageId,model.version,model.getValue()),model:model}}}return{}};return ShellWorker}();exports.ShellWorker=ShellWorker;function create(ctx,createData){return new ShellWorker(ctx,createData)}exports.create=create});